<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lisans Paneli Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #6366f1;
      --dark: #0f172a;
      --darker: #1e293b;
      --light: #e2e8f0;
    }
    body {
      background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
      color: var(--light);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    .glass {
      background: rgba(30, 41, 59, 0.3);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 100, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .title {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .btn-glow {
      background: var(--primary);
      border: none;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
      transition: all 0.3s;
    }
    .btn-glow:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.8);
    }
    .key-box {
      background: #1e293b;
      border: 1px solid #6366f1;
      border-radius: 12px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      color: #a78bfa;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      transition: 0.3s;
    }
    .spinner {
      width: 1.2rem;
      height: 1.2rem;
    }
    .loading {
      text-align: center;
      color: #a78bfa;
      font-style: italic;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="title mb-3">Lisans Paneli Pro</h1>
    <p class="lead text-light">Güvenli • Hızlı • Netlify Üzerinde</p>
  </div>

  <div class="row g-4">
    <!-- LİSANS OLUŞTUR -->
    <div class="col-lg-5">
      <div class="glass p-4 card-hover">
        <h4 class="text-primary mb-3"><i class="fas fa-plus-circle"></i> Yeni Lisans</h4>
        <div class="mb-3">
          <label class="form-label text-light">Geçerlilik Süresi</label>
          <select id="days" class="form-select bg-dark text-light border-primary">
            <option value="1">1 Gün</option>
            <option value="7">7 Gün</option>
            <option value="30" selected>30 Gün</option>
            <option value="90">90 Gün</option>
            <option value="365">1 Yıl</option>
          </select>
        </div>
        <button id="createBtn" onclick="createLicense()" class="btn btn-glow text-white w-100">
          <i class="fas fa-key"></i> Lisans Oluştur
        </button>
        <div id="newKey" class="mt-3"></div>
      </div>
    </div>

    <!-- SON LİSANS LİSTESİ -->
    <div class="col-lg-7">
      <div class="glass p-4 card-hover">
        <h4 class="text-primary mb-3"><i class="fas fa-list"></i> Son Oluşturulanlar</h4>
        <div id="licenseList" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
        </div>
        <div class="text-center mt-3">
          <small class="text-muted">Otomatik yenilenir</small>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-5">
    <small class="text-muted">© 2025 • Netlify Üzerinde Çalışıyor</small>
  </div>
</div>

<script>
async function createLicense() {
  const days = document.getElementById('days').value;
  const btn = document.getElementById('createBtn');
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin spinner"></i> Oluşturuluyor...';
  btn.disabled = true;
  document.getElementById('newKey').innerHTML = '';

  try {
    const res = await fetch('/api/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ days })
    });

    if (!res.ok) {
      const err = await res.text();
      throw new Error(err || 'Sunucu hatası');
    }

    const data = await res.json();

    // GARANTİ: key ve expires var mı?
    if (!data.key || !data.expires) {
      throw new Error('Lisans verisi eksik');
    }

    const expireDate = new Date(data.expires * 1000);

    document.getElementById('newKey').innerHTML = `
      <div class="alert alert-success p-3 mt-3 animate__animated animate__fadeIn">
        <strong>Yeni Lisans:</strong><br>
        <div class="key-box mt-2">${data.key}</div>
        <small class="d-block mt-2">
          Bitiş: ${expireDate.toLocaleString('tr-TR')}
        </small>
      </div>`;
    
    loadLicenses(); // Listeyi yenile
  } catch (e) {
    document.getElementById('newKey').innerHTML = `
      <div class="alert alert-danger p-3 mt-3">
        Hata: ${e.message || 'Bilinmeyen hata'}
      </div>`;
  }

  btn.innerHTML = originalHTML;
  btn.disabled = false;
}

async function loadLicenses() {
  const list = document.getElementById('licenseList');
  list.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';
  try {
    const res = await fetch('/data/licenses.json');
    if (!res.ok) throw new Error('Veri alınamadı');
    
    const licenses = await res.json();
    const recent = licenses.slice(-10).reverse();

    if (recent.length === 0) {
      list.innerHTML = '<div class="text-center text-muted">Henüz lisans yok</div>';
      return;
    }

    list.innerHTML = recent.map(l => {
      const expireDate = new Date(l.expires * 1000);
      const status = l.hwid ? 
        '<span class="badge bg-success"><i class="fas fa-lock"></i> HWID Kilitli</span>' : 
        '<span class="badge bg-warning"><i class="fas fa-clock"></i> Bekliyor</span>';
      
      return `
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary">
          <div>
            <div class="key-box d-inline-block">${l.key}</div>
            <small class="text-muted d-block">${status}</small>
          </div>
          <small class="text-light">${expireDate.toLocaleDateString('tr-TR')}</small>
        </div>
      `;
    }).join('');
  } catch (e) {
    list.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Yüklenemedi: ${e.message}</div>`;
  }
}

// İlk yükleme
loadLicenses();
setInterval(loadLicenses, 15000); // 15 saniyede bir yenile
</script>

<!-- Animasyon için -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</body>
</html>
